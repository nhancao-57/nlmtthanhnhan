<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VTNN Thành Nhân - Solar System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            light: '#4ade80', // A bright agricultural green
                            DEFAULT: '#16a34a', // Standard green
                            dark: '#15803d', // Darker green for hovers
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* Smooth transition for hiding/showing sections */
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans text-gray-800">

    <header class="w-full p-4 flex justify-between items-center max-w-4xl mx-auto">
        <div class="flex items-center space-x-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-brand" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd" />
            </svg>
            <h1 class="font-bold text-lg md:text-xl text-gray-700">VTNN Thành Nhân</h1>
        </div>
        <div class="text-sm font-semibold">
            <button onclick="setLanguage('vi')" class="hover:text-brand transition-colors" id="btn-vi">VN</button>
            <span class="mx-1 text-gray-400">|</span>
            <button onclick="setLanguage('en')" class="hover:text-brand transition-colors text-gray-400" id="btn-en">EN</button>
        </div>
    </header>


    <main class="flex justify-center items-center p-6">
        
        <section id="login-view" class="w-full max-w-md bg-white rounded-2xl shadow-xl overflow-hidden fade-in relative z-10">
            <div class="bg-brand p-8 text-center text-white">
                <h2 class="text-2xl font-bold mb-2" data-i18n="systemTitle">Hệ thống năng lượng mặt trời</h2>
                <p class="opacity-90 text-sm" data-i18n="loginSubtitle">Vui lòng đăng nhập để giám sát</p>
            </div>
            
            <div class="p-8 space-y-6">
                <div>
                    <label for="username" class="block text-sm font-medium text-gray-700 mb-1" data-i18n="labelUser">Tên đăng nhập</label>
                    <input type="text" id="username" class="w-full px-4 py-3 rounded-lg bg-gray-50 border border-gray-300 focus:border-brand focus:ring-2 focus:ring-brand-light outline-none transition-all">
                </div>
                
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700 mb-1" data-i18n="labelPass">Mật khẩu</label>
                    <input type="password" id="password" class="w-full px-4 py-3 rounded-lg bg-gray-50 border border-gray-300 focus:border-brand focus:ring-2 focus:ring-brand-light outline-none transition-all">
                </div>

                <div id="error-msg" class="text-red-500 text-sm text-center hidden"></div>

                <button onclick="login()" id="btn-login" class="w-full bg-brand hover:bg-brand-dark text-white font-bold py-3 rounded-lg transition-all duration-200 transform hover:scale-[1.02] active:scale-[0.98]" data-i18n="btnLogin">
                    Đăng Nhập
                </button>
            </div>
        </section>


        <section id="dashboard-view" class="w-full max-w-4xl hidden fade-in">
            
            <div class="bg-white rounded-2xl shadow-md p-6 mb-6 flex flex-col md:flex-row justify-between items-start md:items-center space-y-4 md:space-y-0">
                <div>
                   <h2 class="text-2xl font-bold text-gray-800" id="plant-name" data-i18n="dashTitle">Tổng quan hệ thống</h2>
                   <p class="text-gray-500 text-sm mt-1">ID: <span id="plant-id">--</span> | <span id="plant-country">--</span></p>
                </div>
                
                <div id="status-badge" class="inline-flex items-center px-4 py-2 rounded-full bg-gray-200 text-gray-700 font-semibold text-sm">
                    <span class="w-3 h-3 bg-gray-500 rounded-full mr-2"></span>
                    <span data-i18n="statusChecking">Đang kiểm tra...</span>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                
                <div class="bg-white rounded-2xl shadow-md p-6 flex items-center space-x-4 border-l-4 border-blue-500">
                    <div class="p-3 bg-blue-100 text-blue-600 rounded-full">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500 uppercase font-semibold tracking-wider" data-i18n="statTotal">Tổng năng lượng</p>
                        <p class="text-3xl font-bold text-gray-800"><span id="total-energy">--</span> <span class="text-lg text-gray-600 font-normal">kWh</span></p>
                    </div>
                </div>

                 <div class="bg-white rounded-2xl shadow-md p-6 flex items-center space-x-4 border-l-4 border-brand">
                    <div class="p-3 bg-green-100 text-brand rounded-full">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500 uppercase font-semibold tracking-wider" data-i18n="statCurrent">Công suất hiện tại</p>
                        <p class="text-3xl font-bold text-gray-800"><span id="current-power">--</span> <span class="text-lg text-gray-600 font-normal">W</span></p>
                    </div>
                </div>
            </div>
            
            <div class="mt-8 text-center">
                <button onclick="logout()" class="text-gray-500 hover:text-red-600 transition font-medium text-sm" data-i18n="btnLogout">Đăng xuất an toàn</button>
            </div>

        </section>

    </main>


    <script>
        const API_URL = '/.netlify/functions/solar';
        let currentLang = 'vi';

        // --- TRANSLATION DICTIONARY ---
        const translations = {
            vi: {
                systemTitle: 'Hệ thống năng lượng mặt trời',
                loginSubtitle: 'Vui lòng đăng nhập để giám sát',
                labelUser: 'Tên đăng nhập',
                labelPass: 'Mật khẩu',
                btnLogin: 'Đăng Nhập',
                btnLoginLoading: 'Đang xử lý...',
                dashTitle: 'Tổng quan hệ thống',
                statusChecking: 'Đang kiểm tra...',
                statusOnline: 'Đang hoạt động',
                statusOffline: 'Đã ngắt kết nối / Ban đêm',
                statTotal: 'Tổng năng lượng đã tạo',
                statCurrent: 'Công suất hiện tại',
                btnLogout: 'Đăng xuất an toàn',
                errorLogin: 'Tên đăng nhập hoặc mật khẩu không đúng.'
            },
            en: {
                systemTitle: 'Solar Energy System',
                loginSubtitle: 'Please login to monitor',
                labelUser: 'Username',
                labelPass: 'Password',
                btnLogin: 'Login',
                btnLoginLoading: 'Processing...',
                dashTitle: 'System Overview',
                statusChecking: 'Checking status...',
                statusOnline: 'Online & Generating',
                statusOffline: 'Offline / Night Mode',
                statTotal: 'Total Energy Generated',
                statCurrent: 'Current Power Output',
                btnLogout: 'Secure Logout',
                errorLogin: 'Invalid username or password.'
            }
        };

        // --- LANGUAGE SWITCHER FUNCTION ---
        function setLanguage(lang) {
            currentLang = lang;
            // Update buttons style
            document.getElementById('btn-vi').className = lang === 'vi' ? 'text-brand font-bold' : 'text-gray-400 hover:text-brand';
            document.getElementById('btn-en').className = lang === 'en' ? 'text-brand font-bold' : 'text-gray-400 hover:text-brand';

            // Update all text elements with data-i18n attribute
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (translations[lang][key]) {
                    element.innerText = translations[lang][key];
                }
            });
        }

        // --- LOGIN LOGIC ---
        async function login() {
            const user = document.getElementById('username').value;
            const pass = document.getElementById('password').value;
            const btn = document.getElementById('btn-login');
            const errDiv = document.getElementById('error-msg');

            if(!user || !pass) return;

            btn.innerText = translations[currentLang]['btnLoginLoading'];
            btn.disabled = true;
            errDiv.classList.add('hidden');

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: user, password: pass })
                });

                const data = await response.json();

                if (response.ok) {
                    renderDashboard(data);
                } else {
                    throw new Error(translations[currentLang]['errorLogin']);
                }
            } catch (error) {
                errDiv.innerText = error.message;
                errDiv.classList.remove('hidden');
                btn.innerText = translations[currentLang]['btnLogin'];
                btn.disabled = false;
            }
        }

        // --- DASHBOARD RENDERING ---
        function renderDashboard(data) {
            // Based on your previous successful API response structure
            if (data.data && data.data.plants && data.data.plants.length > 0) {
                const plant = data.data.plants[0];

                // Populate Data Fields
                document.getElementById('plant-id').innerText = plant.plant_id;
                document.getElementById('plant-country').innerText = plant.country;
                // Assuming plant.name exists, otherwise default.
                if(plant.name) document.getElementById('plant-name').innerText = plant.name;
                
                document.getElementById('total-energy').innerText = parseFloat(plant.total_energy).toLocaleString(currentLang === 'vi' ? 'vi-VN' : 'en-US', {maximumFractionDigits: 2});
                
                // Determine Status based on power output
                // Check both common keys for power: current_power or pac
                const rawPower = plant.current_power || plant.pac || 0;
                const power = parseFloat(rawPower);

                document.getElementById('current-power').innerText = power.toLocaleString(currentLang === 'vi' ? 'vi-VN' : 'en-US');
                
                const statusBadge = document.getElementById('status-badge');
                const statusTextSpan = statusBadge.querySelector('span:last-child');
                const statusDot = statusBadge.querySelector('span:first-child');

                if (power > 0) {
                    // Online State
                    statusBadge.className = "inline-flex items-center px-4 py-2 rounded-full bg-green-100 text-green-800 font-semibold text-sm";
                    statusDot.className = "w-3 h-3 bg-green-500 rounded-full mr-2 animate-pulse";
                    statusTextSpan.innerText = translations[currentLang]['statusOnline'];
                    statusTextSpan.setAttribute('data-i18n', 'statusOnline'); // Ensure it translates if toggled later
                } else {
                    // Offline/Night State
                    statusBadge.className = "inline-flex items-center px-4 py-2 rounded-full bg-gray-200 text-gray-600 font-semibold text-sm";
                    statusDot.className = "w-3 h-3 bg-gray-400 rounded-full mr-2";
                    statusTextSpan.innerText = translations[currentLang]['statusOffline'];
                    statusTextSpan.setAttribute('data-i18n', 'statusOffline');
                }

                // Switch Views with animation classes
                document.getElementById('login-view').classList.add('hidden');
                document.getElementById('dashboard-view').classList.remove('hidden');
            } else {
                alert("Login successful, but no plant data found.");
                location.reload();
            }
        }

        function logout() {
            location.reload();
        }

        // Initialize Language on Load
        setLanguage('vi');
    </script>
</body>
</html>