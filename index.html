<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Power Plant Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Tailwind config -->
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            panel: '#020617',
            bg: '#020617'
          }
        }
      }
    }
  </script>

  <!-- Netlify Identity -->
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
</head>

<body class="bg-slate-950 text-slate-100 min-h-screen flex items-center justify-center">

  <div class="w-full max-w-md rounded-2xl bg-slate-900 shadow-2xl p-6 space-y-6">

    <!-- Header -->
    <div class="text-center">
      <h1 class="text-2xl font-semibold tracking-tight">
        Power Plant Control
      </h1>
      <p class="text-sm text-slate-400">
        Secure operational dashboard
      </p>
    </div>

    <!-- Login -->
    <div id="login" class="text-center">
      <button
        onclick="netlifyIdentity.open()"
        class="w-full py-2.5 rounded-lg bg-blue-600 hover:bg-blue-500 transition font-medium"
      >
        Sign in
      </button>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="hidden space-y-6">

      <!-- Status Card -->
      <div class="rounded-xl bg-slate-800 p-4 space-y-2">
        <div class="flex items-center justify-between">
          <span class="text-sm text-slate-400">Status</span>
          <span id="stateBadge"
            class="px-2 py-0.5 rounded-full text-xs font-medium bg-slate-600">
            —
          </span>
        </div>
        <div class="text-3xl font-bold">
          <span id="power">—</span>
          <span class="text-lg font-medium text-slate-400">MW</span>
        </div>
      </div>

      <!-- Actions -->
      <div class="grid grid-cols-2 gap-3">
        <button
          onclick="loadStatus()"
          class="py-2 rounded-lg bg-slate-700 hover:bg-slate-600 transition"
        >
          Refresh
        </button>
        <button
          onclick="logout()"
          class="py-2 rounded-lg bg-slate-800 hover:bg-slate-700 transition"
        >
          Logout
        </button>
      </div>

      <!-- Footer -->
      <p class="text-xs text-center text-slate-500">
        Data fetched securely via provider API
      </p>
    </div>

  </div>

  <script>
    const login = document.getElementById("login");
    const dashboard = document.getElementById("dashboard");
    const powerEl = document.getElementById("power");
    const stateBadge = document.getElementById("stateBadge");

    function setState(state) {
      stateBadge.textContent = state;

      stateBadge.className =
        "px-2 py-0.5 rounded-full text-xs font-medium " +
        (state === "RUNNING"
          ? "bg-green-600"
          : state === "STOPPED"
          ? "bg-red-600"
          : "bg-yellow-600");
    }

    async function loadStatus() {
      const res = await fetch("/.netlify/functions/status");
      if (!res.ok) {
        alert("Failed to fetch status");
        return;
      }
      const data = await res.json();
      powerEl.textContent = data.power_mw;
      setState(data.state);
    }

    function showDashboard() {
      login.classList.add("hidden");
      dashboard.classList.remove("hidden");
      loadStatus();
    }

    function logout() {
      netlifyIdentity.logout();
    }

    netlifyIdentity.on("login", showDashboard);
    netlifyIdentity.on("logout", () => {
      dashboard.classList.add("hidden");
      login.classList.remove("hidden");
    });

    if (netlifyIdentity.currentUser()) {
      showDashboard();
    }
  </script>

</body>
</html>
